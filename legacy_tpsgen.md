# Generation and Usage of `moqui_tps.in`

This document explains the role, generation process, and usage of the `moqui_tps.in` file within the MQI Communicator system, based on the codebase documentation and the `tps_generator.py` service.

## 1. Overview and Purpose

The `moqui_tps.in` file is a dynamically generated configuration file that serves as the primary input for the MOQUI Treatment Planning System (TPS) executable. Its purpose is to provide the MOQUI simulation engine with all the necessary parameters and file paths required to process a specific medical physics case.

In essence, it acts as a bridge between the high-level case information managed by the MQI Communicator and the low-level computational requirements of the MOQUI engine.

## 2. Generation Process

The `moqui_tps.in` file is generated by the **TPS Generator** service (`src/services/tps_generator.py`). This process is typically initiated by the `WorkflowEngine` as one of the first steps in processing a new case.

The core logic resides in the `create_ini_content` function. Here is a step-by-step breakdown of how the content is created:

1.  **Load Base Parameters**: The generator starts with a set of default parameters defined in the main `config.yaml` file under the `moqui_tps_parameters` section.

2.  **Receive Dynamic Case Data**: The function receives case-specific data, including the `case_id`, the `case_path`, and the `pueue_group` (which indicates the assigned GPU resource, e.g., `gpu_0`).

3.  **Determine GPU ID**: The `GPUID` parameter is dynamically set by parsing the `pueue_group` string. For example, a group named `gpu_0` will result in `GPUID 0`.

4.  **Construct File Paths**: The generator constructs absolute paths for input and output directories. It intelligently determines whether to use local paths or remote High-Performance Computing (HPC) paths based on the configuration (`hpc_config`). This ensures that the MOQUI engine can find the necessary files regardless of where it's executed. Key paths include:
    *   `DicomDir`: The directory containing the case's DICOM files.
    *   `logFilePath`: The path for saving log files.
    *   `ParentDir`: The primary working directory for outputs.
    *   `OutputDir`: The final output directory.
    Paths are formatted with forward slashes (`/`) for compatibility with the remote Linux-based HPC environment.

5.  **Incorporate DICOM Information**: If information from the DICOM RT Plan file is available, the generator extracts details like the number of treatment beams (ignoring any beams named 'SETUP') and the gantry angle of the first treatment beam. These are used to set the `BeamNumbers` and `GantryNum` parameters, respectively.

6.  **Format the Output**: All the parameters (both static from the config and dynamically generated) are formatted into a simple key-value text format (e.g., `key value`).

The resulting string content is then written to a file named `moqui_tps.in` within the specific case's root directory.

## 3. File Structure and Example

The `moqui_tps.in` file uses a simple key-value structure. Comments are denoted with `#`.

```ini
# Key-Value format. Values are populated dynamically at runtime.

GPUID 0
RandomSeed -1932780356
DicomDir /hpc/user/mqi/cases/1.2.840.113854.19.1.19271.1
logFilePath /hpc/user/mqi/interpreter_outputs/1.2.840.113854.19.1.19271.1
ParentDir /hpc/user/mqi/interpreter_outputs/1.2.840.113854.19.1.19271.1
OutputDir /hpc/user/mqi/outputs/1.2.840.113854.19.1.19271.1
BeamNumbers 34
GantryNum 0
# ... other parameters from config.yaml
```

## 4. Usage in the Workflow

Once the `moqui_tps.in` file is created in the case directory, it is used by the next steps in the workflow, which involve executing the MOQUI simulation.

1.  The `WorkflowEngine` proceeds to a step that calls either the `LocalExecutor` or `RemoteExecutor`.
2.  The executor's role is to run the main MOQUI interpreter/executable.
3.  The MOQUI executable, upon starting, reads the `moqui_tps.in` file from its working directory (the case directory).
4.  It uses the parameters within this file to locate the patient's DICOM data, configure the simulation (e.g., which GPU to use), and determine where to write the output files.

Therefore, the `moqui_tps.in` file is a critical component that makes the automated, configurable, and flexible execution of MOQUI simulations possible within the MQI Communicator framework.
